# font = list(
#family = "Sitka Small",
#size = 16,
#color = "black"
#)))
filtered_2012 <- grouped %>%
filter(year ==2012) %>%
arrange(desc(mean_assets))
filtered_2002 <- grouped %>%
filter(year ==2002) %>%
arrange(desc(mean_assets))
filtered_1992 <- grouped %>%
filter(year ==1992) %>%
arrange(desc(mean_assets))
options(scipen=999) # change scientific notation
# now, make a new categorical variable for the bank's rank in terms of assets in possession
filtered_desc$asset_group <- "others" # set default value for all rows
filtered_desc$asset_group[1:5] <- "top-5" # set first 5 rows
filtered_desc$asset_group[6:130] <- "next-125" # set next 125 rows
filtered_2012$asset_group <- "others" # set default value for all rows
filtered_2012$asset_group[1:5] <- "top-5" # set first 5 rows
filtered_2012$asset_group[6:130] <- "next-125" # set next 125 rows
filtered_2002$asset_group <- "others" # set default value for all rows
filtered_2002$asset_group[1:5] <- "top-5" # set first 5 rows
filtered_2002$asset_group[6:130] <- "next-125" # set next 125 rows
filtered_1992$asset_group <- "others" # set default value for all rows
filtered_1992$asset_group[1:5] <- "top-5" # set first 5 rows
filtered_1992$asset_group[6:130] <- "next-125" # set next 125 rows
# merge the 4 decades
merged_decades <- rbind(filtered_1992, filtered_2002, filtered_2012, filtered_desc)
merged_decades <- merged_decades[, -c(5,6)]
merged_decades$asset_group <- as.factor(merged_decades$asset_group) # make asseet group factor type
decades_summarised <- merged_decades %>% # summarise
group_by(year, asset_group) %>%
summarize(total_assets = sum(mean_assets))
years <- c("1992", "2002", "2012", "2022")
p <- ggplot(data=decades_summarised, aes(x=year, y=total_assets, fill=asset_group)) +
geom_bar(stat="identity", position=position_dodge(), colour="black") +
xlab("Year") +
ylab("Total Assets") +
scale_x_continuous(breaks = c(1992, 2002, 2012, 2022)) +
theme_classic()
#scale_fill_manual(values=c("#999999", "#E69F00"))
#plot(p)
ggplotly(p) %>%
layout(title = list(text = paste0('Total Assets in Possession by Bank',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
years <- c("1992", "2002", "2012", "2022")
p <- ggplot(data=decades_summarised, aes(x=year, y=total_assets, fill=asset_group)) +
geom_bar(stat="identity", position=position_dodge(), colour="black") +
xlab("Year") +
ylab("Total Assets") +
scale_x_continuous(breaks = c(1992, 2002, 2012, 2022)) +
theme_classic()
#scale_fill_manual(values=c("#999999", "#E69F00"))
#plot(p)
ggplotly(p) %>%
layout(title = list(text = paste0('<h2>', 'Total Assets in Possession by Bank',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
years <- c("1992", "2002", "2012", "2022")
p <- ggplot(data=decades_summarised, aes(x=year, y=total_assets, fill=asset_group)) +
geom_bar(stat="identity", position=position_dodge(), colour="black") +
xlab("Year") +
ylab("Total Assets") +
scale_x_continuous(breaks = c(1992, 2002, 2012, 2022)) +
theme_classic()
#scale_fill_manual(values=c("#999999", "#E69F00"))
#plot(p)
ggplotly(p) %>%
layout(title = list(text = paste0('<h1>', 'Total Assets in Possession by Bank',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
ggplotly(p) %>%
layout(title = list(text = paste0( '<h1> Total Assets in Possession by Bank',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
ggplotly(p) %>%
layout(title = list(text = paste0('<h1>', 'Total Assets in Possession by Bank', '</h1>',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
ggplotly(p) %>%
layout(title = list(text = paste0('<b>', 'Total Assets in Possession by Bank', '<b>',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
ggplotly(p) %>%
layout(title = list(text = paste0('<font size = "5">', 'Total Assets in Possession by Bank', #'<b>',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
ggplotly(p) %>%
layout(title = list(text = paste0('<b>', 'Total Assets in Possession by Bank', '<b>',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
filter(merged_decades, year == 2022 & asset_group = 'others')
filter(merged_decades, year == 2022 & asset_group == 'others')
getwd()
library(plotly)
library(tidyverse)
library(ggplot2)
library(tidyr)
# lubridate, zoo, xts
merge_csv_files <- function(folder_path) {
# get the list of CSV files in the folder
csv_files <- list.files(folder_path, pattern = "\\.csv$", full.names = TRUE)
# read in all the CSV files and merge them together using rbind()
merged_df <- do.call(rbind, lapply(csv_files, read.csv))
# return the merged data frame
return(merged_df)
}
df <- merge_csv_files("../../data/quarterly_financials/")
year <- substr(df$REPDTE, 1, 4) # add date column
month <- substr(df$REPDTE, 5, 6)
day <- substr(df$REPDTE, 7, 8)
df$date <- as.Date(paste(year, month, day, sep = "-"))
unique(df$BKCLASS)
summary(df$DEPDOM)
# rename bank class names
df$BKCLASS <- replace(df$BKCLASS, df$BKCLASS=="SM", "State Member Banks")
df$BKCLASS <- replace(df$BKCLASS, df$BKCLASS=="NM", "State Nonmember Banks")
df$BKCLASS <- replace(df$BKCLASS, df$BKCLASS=="N", "National Member Banks")
df$BKCLASS <- replace(df$BKCLASS, df$BKCLASS=="SB", "Savings Banks")
df$BKCLASS <- replace(df$BKCLASS, df$BKCLASS=="SI", "Stock & Mutual Savings Banks")
df$BKCLASS <- replace(df$BKCLASS, df$BKCLASS=="SL", "State Stock Savings & Loans")
df$BKCLASS <- replace(df$BKCLASS, df$BKCLASS=="OI", "Other Insured Institutions")
df_agg <- df %>% group_by(date, BKCLASS) %>% summarise(total_deposits = sum(DEPDOM)) # aggregate for different bank classes
#g <- ggplot(df_agg, aes(date, total_deposits))
#p <- g + geom_bar(aes(fill = BKCLASS))
e <- ggplot(df_agg, aes(x = date)) + geom_bar(aes(y = total_deposits, fill = BKCLASS), stat = 'identity') +
ggtitle("Time Series of Total Domestic Deposits, 1992-2022") +
ylab("Total Deposits") +
xlab("Date") +
theme_bw()
ggplotly(e)
# group the data by year, bank name, and quarter and calculate the mean assets
grouped <- df %>%
group_by(year = lubridate::year(date), NAME) %>%
summarize(mean_assets = mean(ASSET))
print(head(grouped))
sorted <- grouped %>%
arrange(desc(mean_assets)) # arrange from largest to smallest by assets
filtered <- grouped %>% # for 2022 plot
filter(year ==2022)
filtered_desc <- filtered %>% # for 2022
arrange(desc(mean_assets))
x <- 10
sliced <- filtered_desc %>% # create sliced df for top 10 banks
slice(1:x)
k <- ggplot(sliced, aes(x = NAME, y = mean_assets)) +
geom_bar(stat = "identity") +
xlab("Bank Name") +
ylab("Mean Assets") +
labs(
title = "Mean Assets by Bank (Top 10) for 2022",
subtitle = "Averaged over quarterly data",
caption = "Source: https://banks.data.fdic.gov/docs/"
) +
theme_classic() +
geom_col(fill = "#008001") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplotly(k) %>%
layout(title = list(text = paste0('Mean Assets by US Banks (Top 10) for 2022',
'<br>',
'<sup>',
'Averaged over quarterly data',
'</sup>')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
# create factor variable asset class
filtered_desc$asset_class <- cut(filtered_desc$mean_assets,
breaks = c(-Inf, 100000, 1000000, 10000000, Inf),
labels = c("<100,000", "100,000-1,000,000", "1,000,000-10,000,000", "10,000,000-4,000,000,000"))
unique(filtered_desc$asset_class)
percent = c('15.7%', '62.4%', '18.3%', '3.6%')
filtered_desc$percent <- ifelse(filtered_desc$asset_class == "<100,000", "15.7%",
ifelse(filtered_desc$asset_class == "100,000-1,000,000", "62.4%",
ifelse(filtered_desc$asset_class == "1,000,000-10,000,000", "18.3%",
"3.6%")))
plot_ly(
x = filtered_desc$asset_class,
type = "histogram",
name = "Asset Class",
visible = TRUE,
showlegend = FALSE,
opacity = 1,
text = list('15.7%', '62.4%', '18.3%', '3.6%'),
#hoverinfo = "Asset Class, Count",
hovertext = "Asset Class, Count",
orientation = "v",
marker = list(color = "green")) |>
layout(title = list(text = "<b>Distribution of US Banks by Assets in Possession, 2022</b>",
font = list(color = "black",
family = "Open Sans",
size = 17
)),
plot_bgcolor = "white",
paper_bgcolor = "white",
xaxis = list(color = "black",
title = "Assets in Possession (USD)",
gridcolor = "white"),
yaxis = list(color = "black",
title = "Count",
gridcolor = "white")
)# |>
#add_trace(
#labels = ~languages,
#values = ~users,
# type = "histogram",
#hovertemplate = "<b><i>Asset Class: %{asset_class}</i></b> <br> <b><i>Count: %{count}</i></b>"
# ) #|>
#layout(hoverlabel = list(
# font = list(
#family = "Sitka Small",
#size = 16,
#color = "black"
#)))
filtered_2012 <- grouped %>%
filter(year ==2012) %>%
arrange(desc(mean_assets))
filtered_2002 <- grouped %>%
filter(year ==2002) %>%
arrange(desc(mean_assets))
filtered_1992 <- grouped %>%
filter(year ==1992) %>%
arrange(desc(mean_assets))
options(scipen=999) # change scientific notation
# now, make a new categorical variable for the bank's rank in terms of assets in possession
filtered_desc$asset_group <- "others" # set default value for all rows
filtered_desc$asset_group[1:5] <- "top-5" # set first 5 rows
filtered_desc$asset_group[6:130] <- "next-125" # set next 125 rows
filtered_2012$asset_group <- "others" # set default value for all rows
filtered_2012$asset_group[1:5] <- "top-5" # set first 5 rows
filtered_2012$asset_group[6:130] <- "next-125" # set next 125 rows
filtered_2002$asset_group <- "others" # set default value for all rows
filtered_2002$asset_group[1:5] <- "top-5" # set first 5 rows
filtered_2002$asset_group[6:130] <- "next-125" # set next 125 rows
filtered_1992$asset_group <- "others" # set default value for all rows
filtered_1992$asset_group[1:5] <- "top-5" # set first 5 rows
filtered_1992$asset_group[6:130] <- "next-125" # set next 125 rows
# merge the 4 decades
merged_decades <- rbind(filtered_1992, filtered_2002, filtered_2012, filtered_desc)
merged_decades <- merged_decades[, -c(5,6)]
merged_decades$asset_group <- as.factor(merged_decades$asset_group) # make asseet group factor type
decades_summarised <- merged_decades %>% # summarise
group_by(year, asset_group) %>%
summarize(total_assets = sum(mean_assets))
years <- c("1992", "2002", "2012", "2022")
p <- ggplot(data=decades_summarised, aes(x=year, y=total_assets, fill=asset_group)) +
geom_bar(stat="identity", position=position_dodge(), colour="black") +
xlab("Year") +
ylab("Total Assets") +
scale_x_continuous(breaks = c(1992, 2002, 2012, 2022)) +
theme_classic()
#scale_fill_manual(values=c("#999999", "#E69F00"))
#plot(p)
ggplotly(p) %>%
layout(title = list(text = paste0('<b>', 'Total Assets in Possession by Bank', '<b>',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
#g <- ggplot(df_agg, aes(date, total_deposits))
#p <- g + geom_bar(aes(fill = BKCLASS))
a <- ggplot(df_agg, aes(x = date)) + geom_bar(aes(y = total_deposits, fill = BKCLASS), stat = 'identity') +
ggtitle("Time Series of Total Domestic Deposits, 1992-2022") +
ylab("Total Deposits") +
xlab("Date") +
theme_bw()
a <- ggplotly(a)
plot(a)
#g <- ggplot(df_agg, aes(date, total_deposits))
#p <- g + geom_bar(aes(fill = BKCLASS))
a <- ggplot(df_agg, aes(x = date)) + geom_bar(aes(y = total_deposits, fill = BKCLASS), stat = 'identity') +
ggtitle("Time Series of Total Domestic Deposits, 1992-2022") +
ylab("Total Deposits") +
xlab("Date") +
theme_bw()
a <- ggplotly(a)
a
#saveWidget(p, file = "plot1.html")
#g <- ggplot(df_agg, aes(date, total_deposits))
#p <- g + geom_bar(aes(fill = BKCLASS))
a <- ggplot(df_agg, aes(x = date)) + geom_bar(aes(y = total_deposits, fill = BKCLASS), stat = 'identity') +
ggtitle("Time Series of Total Domestic Deposits, 1992-2022") +
ylab("Total Deposits") +
xlab("Date") +
theme_bw()
a <- ggplotly(a)
a
saveWidget(a, file = "../../websute/plots/timeseries/plot_1.html")
library(htmlwidgets)
#g <- ggplot(df_agg, aes(date, total_deposits))
#p <- g + geom_bar(aes(fill = BKCLASS))
a <- ggplot(df_agg, aes(x = date)) + geom_bar(aes(y = total_deposits, fill = BKCLASS), stat = 'identity') +
ggtitle("Time Series of Total Domestic Deposits, 1992-2022") +
ylab("Total Deposits") +
xlab("Date") +
theme_bw()
a <- ggplotly(a)
a
saveWidget(a, file = "../../websute/plots/timeseries/plot_1.html")
#g <- ggplot(df_agg, aes(date, total_deposits))
#p <- g + geom_bar(aes(fill = BKCLASS))
a <- ggplot(df_agg, aes(x = date)) + geom_bar(aes(y = total_deposits, fill = BKCLASS), stat = 'identity') +
ggtitle("Time Series of Total Domestic Deposits, 1992-2022") +
ylab("Total Deposits") +
xlab("Date") +
theme_bw()
a <- ggplotly(a)
a
saveWidget(a, file = "../../website/plots/timeseries/plot_1.html")
x <- 10
sliced <- filtered_desc %>% # create sliced df for top 10 banks
slice(1:x)
b <- ggplot(sliced, aes(x = NAME, y = mean_assets)) +
geom_bar(stat = "identity") +
xlab("Bank Name") +
ylab("Mean Assets") +
labs(
title = "Mean Assets by Bank (Top 10) for 2022",
subtitle = "Averaged over quarterly data",
caption = "Source: https://banks.data.fdic.gov/docs/"
) +
theme_classic() +
geom_col(fill = "#008001") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
b <- ggplotly(b) %>%
layout(title = list(text = paste0('Mean Assets by US Banks (Top 10) for 2022',
'<br>',
'<sup>',
'Averaged over quarterly data',
'</sup>')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
saveWidget(b, file = "../../website/plots/timeseries/plot_2.html")
b
percent = c('15.7%', '62.4%', '18.3%', '3.6%')
filtered_desc$percent <- ifelse(filtered_desc$asset_class == "<100,000", "15.7%",
ifelse(filtered_desc$asset_class == "100,000-1,000,000", "62.4%",
ifelse(filtered_desc$asset_class == "1,000,000-10,000,000", "18.3%",
"3.6%")))
c <- plot_ly(
x = filtered_desc$asset_class,
type = "histogram",
name = "Asset Class",
visible = TRUE,
showlegend = FALSE,
opacity = 1,
text = list('15.7%', '62.4%', '18.3%', '3.6%'),
#hoverinfo = "Asset Class, Count",
hovertext = "Asset Class, Count",
orientation = "v",
marker = list(color = "green")) |>
layout(title = list(text = "<b>Distribution of US Banks by Assets in Possession, 2022</b>",
font = list(color = "black",
family = "Open Sans",
size = 17
)),
plot_bgcolor = "white",
paper_bgcolor = "white",
xaxis = list(color = "black",
title = "Assets in Possession (USD)",
gridcolor = "white"),
yaxis = list(color = "black",
title = "Count",
gridcolor = "white")
)# |>
#add_trace(
#labels = ~languages,
#values = ~users,
# type = "histogram",
#hovertemplate = "<b><i>Asset Class: %{asset_class}</i></b> <br> <b><i>Count: %{count}</i></b>"
# ) #|>
#layout(hoverlabel = list(
# font = list(
#family = "Sitka Small",
#size = 16,
#color = "black"
#)))
c
saveWidget(c, file = "../../website/plots/timeseries/plot_3.html")
years <- c("1992", "2002", "2012", "2022")
d <- ggplot(data=decades_summarised, aes(x=year, y=total_assets, fill=asset_group)) +
geom_bar(stat="identity", position=position_dodge(), colour="black") +
xlab("Year") +
ylab("Total Assets") +
scale_x_continuous(breaks = c(1992, 2002, 2012, 2022)) +
theme_classic()
#scale_fill_manual(values=c("#999999", "#E69F00"))
#plot(p)
d <- ggplotly(d) %>%
layout(title = list(text = paste0('<b>', 'Total Assets in Possession by Bank', '<b>',
'<br>',
'<sup>',
'Change in concentration of assets controlled over the past 4 decades',
'</sup>')),
xaxis = list(title = "Year",
categoryorder = "array",
categoryarray = c('1992', '2002', '2012', '2022')),
annotations =
list(x = 1, y = -0.8, text = "Source: https://banks.data.fdic.gov/docs/",
showarrow = F, xref='paper', yref='paper',
xanchor='right', yanchor='auto', xshift=0, yshift=0,
font=list(size=8, color="black"))
)
saveWidget(d, file = "../../website/plots/timeseries/plot_4.html")
d
